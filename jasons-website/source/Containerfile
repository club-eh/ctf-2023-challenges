FROM cgr.dev/chainguard/go:1.19 as build

WORKDIR /build

# download dependencies
COPY --chown=nonroot ./server/go.* ./
RUN go mod download

# copy app source code
COPY --chown=nonroot ./server ./

# build the app
RUN go build -o main .


# use musl-based busybox so entrypoint script can run
FROM cgr.dev/chainguard/busybox:latest

WORKDIR /web

# copy built binary
COPY --from=build /build/main ./main
# copy server files
COPY ./server/assets/ ./assets/
COPY ./server/views/ ./views/
# copy flag
COPY ./flag.txt /flag.txt
# copy entrypoint
COPY --chmod=755 ./entrypoint.sh /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
